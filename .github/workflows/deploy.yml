name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH vÃ o VPS vÃ  deploy container
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ğŸš€ Báº¯t Ä‘áº§u deploy GymFitness API..."

            # XÃ³a code cÅ© vÃ  pull code má»›i
            echo "ğŸ—‘ï¸ XÃ³a code cÅ©..."
            rm -rf /app

            echo "ğŸ“¥ Pull code má»›i..."
            git clone -b main https://github.com/SWD392-SP25/GymFitnessBE.git /app

            # Di chuyá»ƒn vÃ o thÆ° má»¥c GymFitness.API chá»©a Dockerfile vÃ  docker-compose.yml
            cd /app/GymFitness.API

            # Dá»«ng vÃ  xÃ³a container cÅ© (náº¿u cÃ³)
            echo "ğŸ›‘ Dá»«ng vÃ  xÃ³a container cÅ©..."
            docker-compose down

            # XÃ³a image cÅ© Ä‘á»ƒ trÃ¡nh lá»—i cache
            echo "ğŸ—‘ï¸ XÃ³a image cÅ©..."
            docker rmi $(docker images -q) -f || true

            # Táº¡o thÆ° má»¥c config náº¿u chÆ°a cÃ³
            mkdir -p /app/GymFitness.API

            # Ghi file config tá»« GitHub Secrets
            echo "ğŸ“ Ghi file config..."
            echo '${{ secrets.APPSETTINGS_JSON }}' > /app/GymFitness.API/appsettings.json
            echo '${{ secrets.APPSETTINGS_DEVELOPMENT_JSON }}' > /app/GymFitness.API/appsettings.Development.json
            echo '${{ secrets.FIREBASE_CONFIG_JSON }}' > /app/GymFitness.API/firebase_config.json

            # Build vÃ  cháº¡y container tá»« docker-compose.yml
            echo "ğŸš€ Build vÃ  cháº¡y container má»›i..."
            docker-compose up -d --build

            echo "âœ… Deployment hoÃ n táº¥t!"
